---
title: "Working with spatial data available through read.abares"
author: "Adam H. Sparks"
date: "2025-04-01"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Working with spatial data available through read.abares}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  %\VignetteDepends{pander}
  %\VignetteDepends{dplyr}
  %\VignetteDepends{sf}
  %\VignetteDepends{data.table}
---


``` r
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "png"
)
```

This vignette demonstrates some of the functionality of {read.abares} and how to work with some of the spatial and tabular data available through {read.abares}.
Please note that not all functions are demonstrated here, please refer to the [documentation reference](https://adamhsparks.github.io/read.abares/reference/) for a full list of functionality.
The worked examples here show some of the more advanced features that {read.abares} offers beyond just fetching and importing data, _e.g._, Australian Agricultural and Grazing Industries Survey (AAGIS) spatial shapefile which can be used with tabular data from the historical estimates, the Australian Gridded Farm Data, which can be downloaded, cached and then imported using one of four types of object or the soil thickness data, which includes rich metadata.

First we need to load the {read.abares} library.


``` r
library(read.abares)
```

## Working with AAGIS Regions Spatial Data

### Obtaining the AAGIS Regions Spatial Data

ABARES offers spatial data for the Australian Agricultural and Grazing Industries Survey (AAGIS) regions that can be used for mapping tabular data from the estimates, _e.g._, `read_historical_regional_estimates()` or `read_state_estimates()`.


``` r
aagis_regions <- read_aagis_regions(cache = TRUE)
#> Warning: internal error 1 in R_decompress1 with libdeflate
#> Error: lazy-load database '/Users/283204f/Library/R/arm64/4.4/library/read.abares/R/read.abares.rdb' is corrupt

plot(aagis_regions)
```

![plot of chunk aagis-regions](figure/aagis-regions-1.png)

### Obtaining AAGIS Data by Region

{read.abares} offers functions to download the ABARES estimates based on the AAGIS results for national level, `read_historical_national_estimates()`, regional level `read_historical_regional_estimates()`, and state level `read_historical_state_estimates()` and also by performance category `read_estimates_by_performance_category()` and size category `read_estimates_by_size()`.
For this example, we will use the `read_historical_regional_estimates()` function to download the AAGIS data for the regions in the AAGIS regions shapefile and join the data and visualise some of the data.


``` r
aagis_region_data <- read_historical_regional_estimates()
#> Warning: internal error 1 in R_decompress1 with libdeflate
#> Error: lazy-load database '/Users/283204f/Library/R/arm64/4.4/library/read.abares/R/read.abares.rdb' is corrupt
```

### Merging the AAGIS Regions Spatial Data with the AAGIS Regional Data

Using `read_aagis_regions()` and `read_historical_regional_estimates()`, we can merge the two datasets together to visualise the data.
To join the data, we will use the `left_join()` function from the {dplyr} package.


``` r
library(dplyr)

aagis_dat <- left_join(aagis_regions, aagis_region_data)
#> Joining with `by = join_by(ABARES_region)`
```

Once we've joined the data, we can visualise it using {ggplot2}.
Here we can plot the total area cropped (ha) and facet by year for all of Australia.


``` r
library(ggplot2)

total_area <- filter(aagis_dat, Variable == ("Total area cropped (ha)"))

ggplot(total_area) +
  geom_sf(aes(fill = Value)) +
  scale_fill_viridis_c() +
  labs(
    fill = "Total Area Cropped (ha)",
  ) +
  facet_wrap(~Year) +
  theme_minimal()
```

![plot of chunk aagis-regions-plot](figure/aagis-regions-plot-1.png)

## Working With AGFD Data

You can download files and pipe directly into the class object that you desire for the Australian Farm Gridded Data (AGFD) data.

### Description of the Australian Farm Gridded Data

Directly from the DAFF website:

>The Australian Gridded Farm Data are a set of national scale maps containing simulated data on historical broadacre farm business outcomes including farm profitability on an 0.05-degree (approximately 5 km) grid.

>These data have been produced by read.abares as part of the ongoing Australian Agricultural Drought Indicator (AADI) project (previously known as the Drought Early Warning System Project) and were derived using read.abares farmpredict model, which in turn is based on read.abares Agricultural and Grazing Industries Survey (AAGIS) data.

>These maps provide estimates of farm business profit, revenue, costs and production by location (grid cell) and year for the period 1990-91 to 2022-23. The data do not include actual observed outcomes but rather model predicted outcomes for representative or ‘typical' broadacre farm businesses at each location considering likely farm characteristics and prevailing weather conditions and commodity prices.

>The Australian Gridded Farm Data remain under active development, and as such should be considered experimental.

-- Australian Department of Agriculture, Fisheries and Forestry.


Load the {read.abares} library.


``` r
library(read.abares)
```

Check the file format information for the NetCDF files.


``` r
print_agfd_nc_file_format()
#> Warning: internal error 1 in R_decompress1 with libdeflate
#> Error: lazy-load database '/Users/283204f/Library/R/arm64/4.4/library/read.abares/R/read.abares.rdb' is corrupt
```

Download or load from the local cache and read the AGFD files as a list of {stars} objects.


``` r
## A list of {stars} objects
star <- get_agfd(cache = TRUE) |>
  read_agfd_stars()
#> Warning: internal error 1 in R_decompress1 with libdeflate
#> Error: lazy-load database '/Users/283204f/Library/R/arm64/4.4/library/read.abares/R/read.abares.rdb' is corrupt

head(star[[1]])
#> stars object with 2 dimensions and 6 attributes
#> attribute(s):
#>                         Min.         1st Qu.         Median           Mean
#> farmno          15612.000000 233091.50000000 329567.0000000 324737.7187618
#> R_total_hat_ha      2.954396      7.88312157     21.7520529    169.5139301
#> C_total_hat_ha      1.304440      4.34079101      9.9449849     93.2210542
#> FBP_fci_hat_ha   -143.759785      3.60529967     11.5796641     76.2928759
#> FBP_fbp_hat_ha   -349.521639      3.36599833     11.5074294     60.0750936
#> A_wheat_hat_ha      0.000000      0.04062786      0.1114289      0.1365683
#>                        3rd Qu.           Max.   NA's
#> farmno          418508.5000000 669706.0000000 443899
#> R_total_hat_ha     174.8553843   2415.7556059 443899
#> C_total_hat_ha      95.7221857   1853.5385298 443899
#> FBP_fci_hat_ha      77.6748501   1186.5830232 443899
#> FBP_fbp_hat_ha      62.8596117   1240.6003218 443899
#> A_wheat_hat_ha       0.2112845      0.5047761 565224
#> dimension(s):
#>     from  to refsys              values x/y
#> lon    1 886 WGS 84 [886] 112,...,156.2 [x]
#> lat    1 691 WGS 84 [691] -44.5,...,-10 [y]
```

Download or load from the local cache and read the AGFD files as a `terra::rast` object.


``` r
## A {terra} `rast` object
terr <- get_agfd(cache = TRUE) |>
  read_agfd_terra()
#> Warning: internal error 1 in R_decompress1 with libdeflate
#> Error: lazy-load database '/Users/283204f/Library/R/arm64/4.4/library/read.abares/R/read.abares.rdb' is corrupt

head(terr[[1]])
#> class       : SpatRaster 
#> dimensions  : 6, 886, 41  (nrow, ncol, nlyr)
#> resolution  : 0.05, 0.05  (x, y)
#> extent      : 111.975, 156.275, -10.275, -9.975  (xmin, xmax, ymin, ymax)
#> coord. ref. : lon/lat WGS 84 (CRS84) (OGC:CRS84) 
#> source(s)   : memory
#> names       : farmno, R_tot~at_ha, C_tot~at_ha, FBP_f~at_ha, FBP_f~at_ha, A_whe~at_ha, ... 
#> min values  :    NaN,         NaN,         NaN,         NaN,         NaN,         NaN, ... 
#> max values  :    NaN,         NaN,         NaN,         NaN,         NaN,         NaN, ...
```

Download or load from the local cache and read the AGFD files as a list of {tidync} objects.


``` r
## A list of {tidync} objects
tdnc <- get_agfd(cache = TRUE) |>
  read_agfd_tidync()
#> Warning: internal error 1 in R_decompress1 with libdeflate
#> Error: lazy-load database '/Users/283204f/Library/R/arm64/4.4/library/read.abares/R/read.abares.rdb' is corrupt

head(tdnc[[1]])
#> $source
#> # A tibble: 1 × 2
#>   access              source                                                    
#>   <dttm>              <chr>                                                     
#> 1 2025-04-01 14:55:04 /Users/283204f/Library/Caches/org.R-project.R/R/read.abar…
#> 
#> $axis
#> # A tibble: 84 × 3
#>     axis variable       dimension
#>    <int> <chr>              <int>
#>  1     1 lon                    0
#>  2     2 lat                    1
#>  3     3 farmno                 0
#>  4     4 farmno                 1
#>  5     5 R_total_hat_ha         0
#>  6     6 R_total_hat_ha         1
#>  7     7 C_total_hat_ha         0
#>  8     8 C_total_hat_ha         1
#>  9     9 FBP_fci_hat_ha         0
#> 10    10 FBP_fci_hat_ha         1
#> # ℹ 74 more rows
#> 
#> $grid
#> # A tibble: 3 × 4
#>   grid  ndims variables         nvars
#>   <chr> <int> <list>            <int>
#> 1 D0,D1     2 <tibble [41 × 1]>    41
#> 2 D0        1 <tibble [1 × 1]>      1
#> 3 D1        1 <tibble [1 × 1]>      1
#> 
#> $dimension
#> # A tibble: 2 × 8
#>      id name  length unlim coord_dim active start count
#>   <int> <chr>  <dbl> <lgl> <lgl>     <lgl>  <int> <int>
#> 1     0 lon      886 FALSE TRUE      TRUE       1   886
#> 2     1 lat      691 FALSE TRUE      TRUE       1   691
#> 
#> $variable
#> # A tibble: 43 × 7
#>       id name            type      ndims natts dim_coord active
#>    <int> <chr>           <chr>     <int> <int> <lgl>     <lgl> 
#>  1     0 lon             NC_DOUBLE     1     2 TRUE      FALSE 
#>  2     1 lat             NC_DOUBLE     1     2 TRUE      FALSE 
#>  3     2 farmno          NC_DOUBLE     2     1 FALSE     TRUE  
#>  4     3 R_total_hat_ha  NC_DOUBLE     2     1 FALSE     TRUE  
#>  5     4 C_total_hat_ha  NC_DOUBLE     2     1 FALSE     TRUE  
#>  6     5 FBP_fci_hat_ha  NC_DOUBLE     2     1 FALSE     TRUE  
#>  7     6 FBP_fbp_hat_ha  NC_DOUBLE     2     1 FALSE     TRUE  
#>  8     7 A_wheat_hat_ha  NC_DOUBLE     2     1 FALSE     TRUE  
#>  9     8 H_wheat_dot_hat NC_DOUBLE     2     1 FALSE     TRUE  
#> 10     9 A_barley_hat_ha NC_DOUBLE     2     1 FALSE     TRUE  
#> # ℹ 33 more rows
#> 
#> $attribute
#> # A tibble: 49 × 4
#>       id name       variable       value       
#>    <int> <chr>      <chr>          <named list>
#>  1     0 _FillValue lon            <dbl [1]>   
#>  2     1 units      lon            <chr [1]>   
#>  3     0 _FillValue lat            <dbl [1]>   
#>  4     1 units      lat            <chr [1]>   
#>  5     0 _FillValue farmno         <dbl [1]>   
#>  6     0 _FillValue R_total_hat_ha <dbl [1]>   
#>  7     0 _FillValue C_total_hat_ha <dbl [1]>   
#>  8     0 _FillValue FBP_fci_hat_ha <dbl [1]>   
#>  9     0 _FillValue FBP_fbp_hat_ha <dbl [1]>   
#> 10     0 _FillValue A_wheat_hat_ha <dbl [1]>   
#> # ℹ 39 more rows
```

Download or load from the local cache and read the AGFD files as a {data.table} object.


``` r
## A {data.table} object
get_agfd(cache = TRUE) |>
  read_agfd_dt() |>
  head()
#> Warning in head(read_agfd_dt(get_agfd(cache = TRUE))): internal error 1 in
#> R_decompress1 with libdeflate
#> Error in head(read_agfd_dt(get_agfd(cache = TRUE))): lazy-load database '/Users/283204f/Library/R/arm64/4.4/library/read.abares/R/read.abares.rdb' is corrupt
```

## Working With the Soil Thickness Map

You can download the soil depth map and import it as a {stars} or [terra::rast()] object.


``` r
library(read.abares)
get_topsoil_thickness(cache = TRUE) |>
  read_topsoil_thickness_stars()
#> Warning: internal error 1 in R_decompress1 with libdeflate
#> Error: lazy-load database '/Users/283204f/Library/R/arm64/4.4/library/read.abares/R/read.abares.rdb' is corrupt

x <- get_topsoil_thickness(cache = TRUE) |>
  read_topsoil_thickness_terra()
#> Warning: internal error 1 in R_decompress1 with libdeflate
#> Error: lazy-load database '/Users/283204f/Library/R/arm64/4.4/library/read.abares/R/read.abares.rdb' is corrupt
```

For your convenience, {read.abares} re-exports [terra::plot()], so you can just use `plot()` with the {terra} objects in {read.abares}.


``` r
plot(x)
#> Error in h(simpleError(msg, call)): error in evaluating the argument 'x' in selecting a method for function 'plot': object 'x' not found
```

### Soil Thickness Metadata

By default, a brief bit of metadata is printed to the console when you call the topsoil thickness object in your R session.


``` r
library(read.abares)
get_topsoil_thickness(cache = TRUE)
#> Warning: internal error 1 in R_decompress1 with libdeflate
#> Error: lazy-load database '/Users/283204f/Library/R/arm64/4.4/library/read.abares/R/read.abares.rdb' is corrupt
```

But, {read.abares} provides a function for you to browse the topsoil thickness metadata in your console.


``` r
library(read.abares)
get_topsoil_thickness(cache = TRUE) |>
  print_topsoil_thickness_metadata()
#> Warning: internal error 1 in R_decompress1 with libdeflate
#> Error: lazy-load database '/Users/283204f/Library/R/arm64/4.4/library/read.abares/R/read.abares.rdb' is corrupt
```

But you can also access it directly and use [pander::pander()] to include it in a document like this vignette.

<blockquote>

``` r
library(read.abares)
library(pander)
x <- get_topsoil_thickness(cache = TRUE)
#> Warning: restarting interrupted promise evaluation
#> Warning: internal error 1 in R_decompress1 with libdeflate
#> Error: lazy-load database '/Users/283204f/Library/R/arm64/4.4/library/read.abares/R/read.abares.rdb' is corrupt
y <- x$metadata
#> Error: object 'x' not found
pander(y)
#> Error: object 'y' not found
#> Error in if (tail(stdout, 1) == "") {: argument is of length zero
```
</blockquote>
